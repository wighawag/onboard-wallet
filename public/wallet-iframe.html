<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OnBoard Wallet</title>
  </head>

  <body>
    <script>
      const nodeURL = new URL(location.href).searchParams.get("nodeURL");
      console.log({ nodeURL });
      //   console.log(location);

      let firstUrl = null;
      let source = null;
      if (window.opener) {
        throw new Error(`Do not expect to be opened as a window`);
      } else if (window.parent != window) {
        source = window.parent;
      } else {
        console.log("closing");
        window.close();
      }
      console.log("accepting request...");
      if (source) {
        source.postMessage("ready", "*");
      }

      window.addEventListener("message", receiveMessage);

      function receiveMessage(event) {
        if (event.source != source) {
          return;
        }
        if (firstUrl) {
          if (firstUrl != event.origin) {
            return;
          }
        } else {
          firstUrl = event.origin;
        }
        noMessageReceivedYet = false;
        const data = event.data;
        try {
          processMessage(data, event.source);
        } catch (err) {
          event.source.postMessage(
            {
              id: data.id,
              result: null,
              error: { message: "Could not process message data" },
              type: "notValid",
            },
            firstUrl
          );
          console.error(err);
          console.error("The application has sent invalid data");
        }
      }

      function checkMessageNotReceived() {
        if (noMessageReceivedYet) {
          console.error(
            "No transaction received. Please make sure popup are not blocked."
          );
        }
      }

      function closeWindow() {
        closedByCode = true;
        window.close();
      }

      function sendAsync(url, payload, callback) {
        const request = new XMLHttpRequest();
        request.open("POST", url, true);
        request.setRequestHeader("Content-Type", "application/json");

        request.onreadystatechange = function () {
          if (request.readyState === 4) {
            let response = null;
            let error = null;
            try {
              response = JSON.parse(request.responseText);
            } catch (err) {
              const message =
                !!result && !!result.error && !!result.error.message
                  ? result.error.message
                  : "Invalid JSON RPC response: " + JSON.stringify(response);
              error = { message: message, type: "JsonParse" };
            }

            let result = response.result;
            if (!error && response.error) {
              error = response.error;
              result = undefined;
            }

            callback(error, result);
          }
        };

        try {
          request.send(JSON.stringify(payload));
        } catch (e) {
          callback({
            message: "CONNECTION ERROR: Couldn't connect to node " + url + ".",
            type: "noConnection",
          });
        }
      }

      function isMethodAllowed(method) {
        // TODO
        return true;
      }

      function processMessage(data, sourceWindow) {
        if (isMethodAllowed(data.request.method)) {
          sendAsync(
            nodeURL,
            { ...data.request, id: data.id, jsonrpc: "2.0" },
            function (error, result) {
              sourceWindow.postMessage(
                {
                  type: "onboard:response",
                  id: data.id,
                  result: result,
                  error: error,
                },
                firstUrl
              );
            }
          );
        } else {
          sourceWindow.postMessage(
            {
              id: data.id,
              result: null,
              error: {
                message:
                  "method (" + data.payload.method + ") not allowed in iframe",
              },
              type: "notAllowed",
            },
            firstUrl
          );
        }
      }
    </script>
  </body>
</html>
